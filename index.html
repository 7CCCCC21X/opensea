<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>OpenSea XP æ‰¹é‡æŸ¥è¯¢</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />

<!-- ç½‘ç«™ Logo -->
<link rel="icon" href="s4bg0-lc131-001.ico" type="image/x-icon" />
<link rel="shortcut icon" href="s4bg0-lc131-001.ico" type="image/x-icon" />

<style>
:root{
  --c-bg:#f9f9f9;        --c-card:#fff;
  --c-text:#333;         --c-sub:#666;
  --c-primary:#0078d4;   --c-primary-dark:#005fa3;
  --xp-low:#9ca3af;      --xp-mid:#3b82f6;  --xp-high:#16a34a;
}
@media (prefers-color-scheme: dark){
  :root{
    --c-bg:#111827;--c-card:#1f2937;
    --c-text:#e5e7eb;--c-sub:#9ca3af;
  }
}
body{background:var(--c-bg);color:var(--c-text);font-family:"Segoe UI",PingFang SC,"Microsoft YaHei",sans-serif;margin:0}
.container{max-width:960px;margin:auto;padding:24px}
h1{text-align:center;margin:0 0 10px;font-size:26px;color:var(--c-primary)}
.author{text-align:center;margin-bottom:20px;font-size:14px}
.author a{color:var(--c-primary);text-decoration:none}
.author a:hover{text-decoration:underline}
.sticky{position:sticky;top:0;z-index:10;background:var(--c-bg);padding:12px 0;border-bottom:1px solid #e5e7eb}
textarea{width:100%;height:140px;border:1px solid #ccc;border-radius:6px;padding:12px;font-size:14px;resize:vertical}
.controls{margin-top:12px;text-align:center;gap:10px;display:flex;flex-wrap:wrap;justify-content:center}
button{background:var(--c-primary);color:#fff;border:none;border-radius:6px;padding:8px 18px;font-size:15px;cursor:pointer;transition:.2s}
button:hover{background:var(--c-primary-dark)}
button:disabled{opacity:.5;cursor:not-allowed}
label{font-weight:600}
/* è¿›åº¦æ¡ + ç»Ÿè®¡ */
.progress{display:none;align-items:center;gap:8px;margin-top:10px;justify-content:center}
progress{width:180px;height:12px}
#stats{display:none;text-align:center;font-weight:600;margin:6px 0 0}
.table-wrap{overflow-x:auto;margin-top:24px}
table{width:100%;border-collapse:collapse;font-size:15px;min-width:620px}
th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left}
th{background:var(--c-card);position:sticky;top:0;z-index:5;cursor:pointer;user-select:none}
tr:nth-child(even){background:rgba(0,0,0,.03)}
.loading{color:var(--c-sub);font-style:italic}
.xp-low{color:var(--xp-low)}
.xp-mid{color:var(--xp-mid)}
.xp-high{color:var(--xp-high)}
#empty{display:none;margin:40px 0;text-align:center;color:var(--c-sub)}
.options{display:flex;flex-wrap:wrap;justify-content:center;gap:18px;margin-top:6px;font-size:14px}
.options label{cursor:pointer}
.theme-toggle{position:fixed;right:16px;bottom:16px;padding:6px 10px;font-size:13px}
@media (max-width:480px){table{font-size:13px}}
</style>
</head>
<body>
<div class="container">

  <h1>OpenSea XP æ‰¹é‡æŸ¥è¯¢</h1>
  <div class="author"><a href="https://x.com/0xXIAOc" target="_blank" rel="noopener">ä½œè€…æ¨ç‰¹ @0xXIAOc</a></div>

  <!-- ===== è¾“å…¥ & æ§ä»¶ ===== -->
  <div class="sticky">
    <label for="addresses">è¾“å…¥é’±åŒ…åœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
    <textarea id="addresses"></textarea>

    <div class="controls">
      <button id="queryBtn">å¼€å§‹æŸ¥è¯¢</button>
      <button id="exportBtn" disabled>å¯¼å‡º CSV</button>
      <button id="copyBtn"   disabled>å¤åˆ¶è¡¨æ ¼</button>
    </div>

    <div class="options">
      <label><input type="checkbox" id="privacyChk"> åªæ˜¾ç¤ºå‰ 6 ä½</label>
      <label><input type="checkbox" id="darkToggle"> æ·±è‰²æ¨¡å¼</label>
    </div>

    <!-- è¿›åº¦ -->
    <div class="progress" id="progWrap">
      <progress id="progressBar" value="0" max="100"></progress>
      <span id="progressText">0 %</span>
    </div>

    <!-- ç»Ÿè®¡æ¡ï¼ˆç´§è·Ÿè¿›åº¦æ¡ï¼‰ -->
    <div id="stats">
      æŸ¥è¯¢åœ°å€æ€»æ•° : <span id="countInput">0</span>&emsp;
      æœ‰ XP çš„åœ°å€æ•°é‡ : <span id="countHasXP">0</span>&emsp;
      æ€» XP : <span id="sumXP">0</span>
    </div>
  </div>

  <!-- ===== ç»“æœ ===== -->
  <div id="empty">æš‚æ— æ•°æ®ï¼Œè¯·è¾“å…¥åœ°å€å¹¶ç‚¹å‡»ã€Œå¼€å§‹æŸ¥è¯¢ã€</div>

  <div class="table-wrap">
    <table id="resultTable" style="display:none">
      <thead>
        <tr>
          <th>#</th>
          <th>åœ°å€</th>
          <th id="xpHeader" data-order="desc">æ€» XP â–¾</th>
          <th>çŠ¶æ€</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<button class="theme-toggle" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>

<script>
/* ---------- å…¨å±€é…ç½® ---------- */
const ENDPOINT = 'https://gql.opensea.io/graphql';
const HEADERS  = {'Content-Type':'application/json','x-app-id':'os2-web','accept':'application/graphql-response+json, application/json'};
const CONCURRENCY = 5;

/* ---------- DOM ---------- */
const txtArea   = document.getElementById('addresses');
const btnQuery  = document.getElementById('queryBtn');
const btnExport = document.getElementById('exportBtn');
const btnCopy   = document.getElementById('copyBtn');
const tableWrap = document.getElementById('resultTable');
const tbody     = tableWrap.querySelector('tbody');
const progWrap  = document.getElementById('progWrap');
const progBar   = document.getElementById('progressBar');
const progTxt   = document.getElementById('progressText');
const statsBox  = document.getElementById('stats');
const countInputEl = document.getElementById('countInput');
const countHasXPEl = document.getElementById('countHasXP');
const sumXPEl   = document.getElementById('sumXP');
const emptyTip  = document.getElementById('empty');
const xpHeader  = document.getElementById('xpHeader');
const privacyChk= document.getElementById('privacyChk');
const darkToggle= document.getElementById('darkToggle');
const themeBtn  = document.getElementById('themeBtn');

/* ---------- å·¥å…· ---------- */
function mask(addr){
  return privacyChk.checked ? addr.slice(0,8)+'â€¦' : addr;
}
function xpClass(xp){
  if(xp===0) return 'xp-low';
  if(xp<200) return 'xp-low';
  if(xp<500) return 'xp-mid';
  return 'xp-high';
}
function createRow(idx,address){
  const row = tbody.insertRow();
  row.insertCell().textContent = idx;
  row.insertCell().textContent = mask(address);
  const xpCell = row.insertCell(); xpCell.textContent='æŸ¥è¯¢ä¸­â€¦'; xpCell.className='loading';
  row.insertCell().textContent='âŒ›';
  row.dataset.address = address;
  row.dataset.xp = 0;
  return row;
}
async function fetchXP(address){
  const body = {
    operationName:'LeaderboardXP',
    query:`query LeaderboardXP($address: Address!) { userXP(address: $address) { totalXP } }`,
    variables:{address}
  };
  const res = await fetch(ENDPOINT,{method:'POST',headers:HEADERS,body:JSON.stringify(body)});
  if(!res.ok) throw new Error(res.status);
  const j = await res.json();
  return j?.data?.userXP?.totalXP ?? 0;
}

/* ---------- ä¸»é€»è¾‘ ---------- */
btnQuery.addEventListener('click', async ()=>{
  const addresses = [...new Set(txtArea.value.split(/\s+/).map(s=>s.trim()).filter(Boolean))];
  if(!addresses.length){ emptyTip.style.display='block'; return; }
  emptyTip.style.display='none';
  tableWrap.style.display='table';
  tbody.innerHTML='';
  btnExport.disabled = btnCopy.disabled = true;
  progWrap.style.display='flex';
  statsBox.style.display='block';
  progBar.value=0; progTxt.textContent='0 %';
  countInputEl.textContent=addresses.length;
  countHasXPEl.textContent=sumXPEl.textContent=0;

  let done=0,sumXP=0,hasXP=0;
  const queue=[...addresses];
  const workers = Array(CONCURRENCY).fill(0).map(async ()=>{
    while(queue.length){
      const addr = queue.shift();
      const row  = createRow(addresses.indexOf(addr)+1,addr);
      try{
        const xp = await fetchXP(addr);
        row.cells[2].textContent = xp||'â€”';
        row.cells[2].className = xpClass(xp);
        row.cells[3].textContent='âœ…';
        row.dataset.xp = xp;
        sumXP += xp;
        if(xp>0) hasXP++;
      }catch{ row.cells[2].textContent='--'; row.cells[3].textContent='âŒ'; }
      done++; const pct=Math.round(done/addresses.length*100);
      progBar.value=pct; progTxt.textContent=pct+' %';
      sumXPEl.textContent=sumXP;
      countHasXPEl.textContent=hasXP;
    }
  });
  await Promise.all(workers);
  progWrap.style.display='none';
  btnExport.disabled = btnCopy.disabled = false;
});

/* ---------- å¯¼å‡º / å¤åˆ¶ ---------- */
btnExport.addEventListener('click',()=>{
  let csv='index,address,xp\n';
  [...tbody.rows].forEach(r=>csv+=`${r.cells[0].textContent},${r.dataset.address},${r.dataset.xp}\n`);
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url;a.download='opensea_xp.csv';a.click();URL.revokeObjectURL(url);
});
btnCopy.addEventListener('click',async()=>{
  let txt=''; [...tbody.rows].forEach(r=>txt+=`${r.cells[0].textContent}\t${r.dataset.address}\t${r.dataset.xp}\n`);
  await navigator.clipboard.writeText(txt.trim()); alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
});

/* ---------- æ’åº ---------- */
xpHeader.addEventListener('click',()=>{
  const order = xpHeader.dataset.order==='desc'?'asc':'desc';
  xpHeader.dataset.order=order;
  xpHeader.innerHTML = `æ€»&nbsp;XP&nbsp;${order==='desc'?'â–¾':'â–´'}`;
  const rows=[...tbody.rows].sort((a,b)=>order==='desc'?b.dataset.xp-a.dataset.xp:a.dataset.xp-b.dataset.xp);
  tbody.append(...rows);
});

/* ---------- ä¸»é¢˜ & éšç§åˆ‡æ¢ ---------- */
function applyTheme(){ document.documentElement.classList.toggle('dark',darkToggle.checked); }
darkToggle.addEventListener('change',applyTheme);
themeBtn.addEventListener('click',()=>{ darkToggle.checked=!darkToggle.checked; applyTheme(); });
privacyChk.addEventListener('change',()=>{ [...tbody.rows].forEach(r=>r.cells[1].textContent=mask(r.dataset.address)); });
</script>
</body>
</html>
